# 项目介绍

SM4 是我国自主设计的分组密码算法，属于国密标准（GB/T 32907-2016），主要用于数据加密保护，在金融、政务、通信等敏感领域有着广泛应用。

### **一、核心特性**

- **分组长度**：128 位（与 AES 相同），即每次处理 16 字节的数据块。
- **密钥长度**：128 位，密钥固定为 16 字节，安全性与 AES-128 相当。
- **加密轮数**：共 32 轮迭代，每轮使用不同的轮密钥，增强抗攻击能力。
- **用途**：支持数据加密、解密、密钥交换等场景，可用于替代 AES 在国内合规场景中使用。

### **二、算法结构**

SM4 采用**Feistel 结构**，整体流程包括**密钥扩展**和**加密 / 解密过程**两部分：

#### 1. 密钥扩展

- 输入：128 位主密钥（16 字节）。
- 输出：32 个轮密钥（每个 128 位），供 32 轮加密迭代使用。
- 过程：通过固定的密钥扩展算法，结合非线性变换和线性变换，从主密钥生成轮密钥，确保轮密钥的随机性和安全性。

#### 2. 加密 / 解密过程

- **加密**：明文分组（128 位）经过 32 轮迭代处理，每轮包含 4 个核心操作，最终输出密文分组。
- **解密**：与加密流程类似，但轮密钥使用顺序相反（第 32 轮轮密钥首先使用），确保密文可被正确还原为明文。

### **三、核心操作**

每轮迭代对 128 位数据进行 4 步处理，核心是**非线性变换**和**线性变换**的结合：

1. **异或轮密钥**：将当前数据与本轮轮密钥进行异或。
2. **S 盒替换（非线性变换）**：将 128 位数据拆分为 16 个字节，每个字节通过固定的 S 盒（8 位输入→8 位输出）进行替换，引入非线性特性（抗线性攻击的关键）。
3. **线性变换（L 变换）**：对 S 盒输出的 16 字节进行移位和异或操作，扩散数据的影响范围，确保明文的微小变化会扩散到整个密文（雪崩效应）。
4. **异或反馈**：将处理结果与上一轮的中间数据异或，形成 Feistel 结构的反馈。

# 四、项目优化操作

## （一） T-table 优化

核心思想是将轮函数中的**S 盒非线性替换**与**L 线性变换**合并为一个查表操作（T 表），减少计算步骤和指令开销。

SM4 轮函数的核心操作是`T(·)`，其定义为：
`T(X) = L(S(X))`
其中：

- `S(X)`：对 128 位输入`X`的 16 个字节分别进行 S 盒替换（非线性变换）。
- `L(X)`：对`S(X)`的输出进行线性变换（包含多次左移和异或）。

在原始实现中，`S`和`L`是分步执行的：先逐个字节做 S 盒替换，再对结果执行线性变换。这会导致大量的字节级操作和循环，效率较低。
**T 表优化**通过预计算`S`和`L`的复合结果，将两步合并为一步查表，直接得到最终结果。

**优化后的轮函数执行流程：** 

原始轮函数中，`T(X)`需要对 128 位数据的 4 个 32 位字分别处理。优化后：

1. 将 128 位输入`X`拆分为 4 个 32 位字`X0, X1, X2, X3`。
2. 对每个字的 4 个字节（`b0, b1, b2, b3`），直接查 T 表：
   `T(b0) | (T(b1) << 8) | (T(b2) << 16) | (T(b3) << 24)`
   （将 4 个字节的 T 表结果拼接为 32 位字）。
3. 省去单独的 S 盒替换和线性变换步骤，直接得到`T(X)`的结果。

- **优势**：
  1. **减少指令数**：将 S 盒替换（16 次查表）和线性变换（多次移位 + 异或）合并为 16 次查表，减少循环和计算步骤。
  2. **提升缓存利用率**：T 表仅 256×4=1024 字节，可完全放入 CPU 一级缓存，查表延迟极低。
  3. **易于并行化**：在支持向量指令（如 AES-NI、AVX）的平台上，可通过一次向量查表操作处理 16 个字节，进一步提升效率。

## （二）SIMD 优化

使用 SIMD 技术优化 SM4 算法，核心是利用 CPU 的向量指令集并行处理 128 位分组数据，将字节级操作提升为向量级并行操作，从而显著提升加解密效率。

**核心原理** 

SM4 算法的分组长度为 128 位，与主流 SIMD 指令集的向量寄存器长度天然匹配。通过将 SM4 的轮函数操作映射为 SIMD 向量指令，可实现：

- **并行处理**：一次指令操作 16 个字节（128 位），替代传统的循环逐个字节处理。
- **减少指令开销**：用单条向量指令替代多条标量指令，降低循环控制和内存访问成本。
- **利用硬件加速**：SIMD 指令由硬件直接支持，执行延迟远低于软件模拟。

### **关键操作的 SIMD 优化实现** 

#### 1. **S 盒替换的并行化（核心优化点）** 

SM4 的 S 盒是 8 位输入输出的非线性变换，需对 128 位分组中的 16 个字节逐个替换。SIMD 优化通过**向量查表指令**实现 16 字节并行替换：

- **预准备**：将 SM4 的 S 盒（256 个 8 位值）存入一个 128 位向量寄存器（或内存数组），作为查找表。
- **并行查表**：使用 SIMD 的字节乱序指令，一次完成 16 个字节的 S 盒替换。

#### 2. **线性变换（L 变换）的向量加速**

SM4 的 L 变换定义为：`L(x) = x ^ (x << 2) ^ (x << 10) ^ (x << 18) ^ (x << 24)`。SIMD 优化通过以下步骤并行处理 4 个 32 位字）：

- **向量移位**：使用 SIMD 的移位指令对 128 位向量中的 4 个 32 位字同时执行左移（2/10/18/24 位）。

#### 3. **轮密钥加与轮函数的整合**

- **轮密钥异或**：轮密钥本身为 128 位，可直接存入 SIMD 寄存器，通过`PXOR`等向量异或指令与当前数据块并行异或。
- **轮函数流水线**：将 S 盒替换、L 变换、轮密钥异或等操作打包为 SIMD 指令流，减少中间结果的内存读写，充分利用 CPU 流水线。

**SIMD** 优化通过将 SM4 的字节级串行操作转化为并行操作，可使加解密速度提升数倍。

## （三）、AES-NI 优化 SM4

由于 SM4 和 AES 的S盒都基于有限域逆运算，可以通过仿射变换将SM4-S盒转换为AES-S盒格式，AES-NI指令集包含专门为AES设计的硬件指令，然后利用其中的AESENC指令来加速SM4的S盒操作。

若有兴趣，可以参考他人项目 [mjosaarinen/sm4ni：演示 AES-NI 指令可用于实现中国加密标准 SM4](https://github.com/mjosaarinen/sm4ni)

## （四）、SM4-GCM 工作模式

​	**SM4-GCM** 是将 SM4 分组密码算法与 GCM工作模式结合的一种认证加密方案，兼具数据加密和完整性校验功能，适用于需要同时保障机密性与真实性的场景。

**优势**

1. **双重功能**：同时提供**加密**和**认证**，无需额外使用哈希函数或 HMAC。
2. **效率优势**：加密与认证可并行计算，处理速度接近纯加密模式。
3. **灵活性**：支持附加数据的认证，这些数据不加密但需确保完整性。

# 参考文献

1. [国家标准|GB/T 32907-2016](https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=7803DE42D3BC5E80B0C3E5D8E873D56A&refer=outter)

2. [Fast software implementation of SM4](http://journal.ucas.ac.cn/EN/10.7523/j.issn.2095-6134.2018.02.005)
